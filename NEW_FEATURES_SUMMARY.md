# é€šèƒœAI - ä¸‰é¡¹æ ¸å¿ƒåŠŸèƒ½æ›´æ–°

## ğŸ¯ åŠŸèƒ½æ¦‚è§ˆ

æœ¬æ¬¡æ›´æ–°æ–°å¢ä¸‰é¡¹æ ¸å¿ƒåŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå®‰å…¨æ€§ï¼š

1. **å†å²è®°å½•åˆ é™¤æƒé™ä¿®å¤** âœ…
2. **AIä½¿ç”¨æ¬¡æ•°è¿½è¸ªç³»ç»Ÿ** ğŸ”¢
3. **æµå¹´åˆ†æåŠŸèƒ½** ğŸ“…

---

## 1ï¸âƒ£ å†å²è®°å½•åˆ é™¤æƒé™ä¿®å¤

### é—®é¢˜æè¿°
- ç”¨æˆ·ç•Œé¢æœ‰"åˆ é™¤"æŒ‰é’®ï¼Œä½†æ•°æ®åº“RLSç­–ç•¥ç¼ºå°‘DELETEæƒé™
- å¯¼è‡´åˆ é™¤æ“ä½œå¤±è´¥ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

### è§£å†³æ–¹æ¡ˆ
```sql
CREATE POLICY "Users can delete own bazi records"
ON public.bazi_records
FOR DELETE
TO authenticated
USING (auth.uid() = user_id);
```

### åŠŸèƒ½ç‰¹ç‚¹
- âœ… ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„å…«å­—è®°å½•
- âœ… å®‰å…¨ï¼šåªèƒ½åˆ é™¤è‡ªå·±çš„è®°å½•
- âœ… åˆ é™¤æ“ä½œæœ‰äºŒæ¬¡ç¡®è®¤æç¤º
- âœ… åˆ é™¤åè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨

---

## 2ï¸âƒ£ AIä½¿ç”¨æ¬¡æ•°è¿½è¸ªç³»ç»Ÿ

### åŠŸèƒ½è¯´æ˜
å®ç°ä¼šå‘˜åˆ†çº§çš„AIè§£è¯»æ¬¡æ•°é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿèµ„æºã€‚

### ä¼šå‘˜ç­‰çº§é™åˆ¶
| ä¼šå‘˜ç­‰çº§ | æœˆåº¦AIè§£è¯»æ¬¡æ•° | ç‰¹ç‚¹ |
|---------|--------------|------|
| Free | 3æ¬¡ | åŸºç¡€è¯•ç”¨ |
| Basic | 20æ¬¡ | æ»¡è¶³ä¸€èˆ¬éœ€æ±‚ |
| Premium | 100æ¬¡ | æ·±åº¦ä½¿ç”¨ |
| VIP | æ— é™åˆ¶ | å®Œå…¨è‡ªç”± |

### æ•°æ®åº“è®¾è®¡
**æ–°å¢è¡¨ï¼šai_usage_records**
```sql
CREATE TABLE public.ai_usage_records (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL,
  usage_type text NOT NULL DEFAULT 'ai_reading',
  created_at timestamp NOT NULL,
  bazi_record_id uuid REFERENCES bazi_records
);
```

### æŠ€æœ¯å®ç°

#### 1. è‡ªå®šä¹‰Hook: `useAIUsage`
```typescript
// src/hooks/useAIUsage.ts
export const useAIUsage = () => {
  const [usageCount, setUsageCount] = useState<number>(0);
  
  // è·å–æœ¬æœˆä½¿ç”¨æ¬¡æ•°
  const fetchUsageCount = async () => {
    // æŸ¥è¯¢å½“æœˆè®°å½•æ•°
  };
  
  // è®°å½•ä¸€æ¬¡ä½¿ç”¨
  const recordUsage = async (baziRecordId?: string) => {
    // æ’å…¥ä½¿ç”¨è®°å½•
  };
  
  return { usageCount, recordUsage, refetch };
};
```

#### 2. æ›´æ–° `useMembership` Hook
```typescript
const canUseAI = (currentUsage: number) => {
  if (!membership) return false;
  const limit = MEMBERSHIP_FEATURES[membership.tier].aiReadings;
  return limit === -1 || currentUsage < limit;
};
```

#### 3. Edge Function é›†æˆ
```typescript
// supabase/functions/ai-reading/index.ts
// ç”ŸæˆAIè§£è¯»åè‡ªåŠ¨è®°å½•ä½¿ç”¨
await supabase
  .from('ai_usage_records')
  .insert({
    user_id: userIdToUse,
    usage_type: 'ai_reading',
    bazi_record_id: baziRecordId,
  });
```

#### 4. å‰ç«¯é›†æˆ
```typescript
const handleAiReading = async (type: string) => {
  // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
  if (!canUseAI(usageCount)) {
    toast({ title: 'ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™' });
    return;
  }
  
  // è°ƒç”¨AIè§£è¯»
  const { data } = await supabase.functions.invoke('ai-reading', ...);
  
  // è®°å½•ä½¿ç”¨
  await recordUsage(recordId);
};
```

### ç”¨æˆ·ä½“éªŒ
- âœ… è¾¾åˆ°é™åˆ¶æ—¶å‹å¥½æç¤º
- âœ… å®æ—¶æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°ï¼ˆå¯æ‰©å±•ï¼‰
- âœ… å¼•å¯¼ç”¨æˆ·å‡çº§ä¼šå‘˜
- âœ… æ¯æœˆè‡ªåŠ¨é‡ç½®æ¬¡æ•°

### å®‰å…¨æœºåˆ¶
- âœ… ä½¿ç”¨RLSç­–ç•¥ä¿æŠ¤æ•°æ®
- âœ… å‰åç«¯åŒé‡éªŒè¯
- âœ… é˜²æ­¢ç»•è¿‡å®¢æˆ·ç«¯é™åˆ¶
- âœ… è®°å½•è¯¦ç»†è¿½è¸ªæ—¥å¿—

---

## 3ï¸âƒ£ æµå¹´åˆ†æåŠŸèƒ½

### åŠŸèƒ½è¯´æ˜
å±•ç¤ºæœªæ¥5å¹´çš„æµå¹´è¿åŠ¿é¢„æµ‹ï¼Œå¸®åŠ©ç”¨æˆ·è§„åˆ’äººç”Ÿå†³ç­–ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸ“… æ˜¾ç¤ºæœªæ¥5å¹´æµå¹´
- ğŸ¯ æ¯å¹´å¤©å¹²åœ°æ”¯
- ğŸ“Š è¿åŠ¿è¶‹åŠ¿æŒ‡æ ‡ï¼ˆå‰/å¹³/å‡¶ï¼‰
- ğŸ“ ç™½è¯è¿åŠ¿è¯´æ˜
- ğŸ” ä¼šå‘˜ä¸“äº«AIæ·±åº¦è§£è¯»

### ç»„ä»¶å®ç°
```typescript
// src/components/reading/LiunianAnalysis.tsx
export const LiunianAnalysis = ({ 
  baziRecordId, 
  birthYear, 
  baziData 
}) => {
  // è®¡ç®—æœªæ¥5å¹´æµå¹´
  const generateLiunianAnalyses = () => {
    // å¤©å¹²åœ°æ”¯è®¡ç®—
    // è¿åŠ¿è¶‹åŠ¿åˆ¤æ–­
  };
  
  // AIæ·±åº¦è§£è¯»ï¼ˆä¼šå‘˜åŠŸèƒ½ï¼‰
  const loadAIAnalysis = async () => {
    // è°ƒç”¨AIæœåŠ¡
  };
};
```

### ç•Œé¢å±•ç¤º
```
ğŸ“… 2025å¹´ (33å²) ä¹™å·³å¹´ â†— è¿åŠ¿é¡ºé‚ï¼Œé€‚åˆå¼€æ‹“è¿›å–
ğŸ“… 2026å¹´ (34å²) ä¸™åˆå¹´ â†’ è¿åŠ¿å¹³ç¨³ï¼Œå®ˆæˆä¸ºå®œ
ğŸ“… 2027å¹´ (35å²) ä¸æœªå¹´ â†˜ éœ€è°¨æ…è¡Œäº‹ï¼Œé˜²èŒƒé£é™©
...
```

### è¿åŠ¿æŒ‡æ ‡
| å›¾æ ‡ | è¶‹åŠ¿ | é¢œè‰² | è¯´æ˜ |
|-----|-----|-----|------|
| â†— | å‰ | ç»¿è‰² | è¿åŠ¿ä¸Šå‡ï¼Œé€‚åˆå‘å±• |
| â†’ | å¹³ | é»„è‰² | è¿åŠ¿å¹³ç¨³ï¼Œä¿æŒçŠ¶æ€ |
| â†˜ | å‡¶ | çº¢è‰² | éœ€è°¨æ…ï¼Œé˜²èŒƒé£é™© |

### æ•°æ®åº“è®¾è®¡
**æ–°å¢è¡¨ï¼šliunian_analyses**
```sql
CREATE TABLE public.liunian_analyses (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL,
  bazi_record_id uuid NOT NULL,
  year integer NOT NULL,
  analysis jsonb NOT NULL,
  created_at timestamp NOT NULL,
  UNIQUE(bazi_record_id, year)
);
```

### é¡µé¢é›†æˆ
```typescript
// src/pages/Bazi.tsx
{result && (
  <>
    <DayunChart ... />
    <LiunianAnalysis 
      baziRecordId={recordId}
      birthYear={parseInt(year)}
      baziData={result}
    />
  </>
)}
```

### æœªæ¥æ‰©å±•
- [ ] é›†æˆçœŸå®å‘½ç†ç®—æ³•
- [ ] æ¯å¹´è¯¦ç»†å‰å‡¶åˆ†æ
- [ ] å¯ç‚¹å‡»æŸ¥çœ‹å¹´ä»½è¯¦æƒ…
- [ ] AIæ·±åº¦æµå¹´è§£è¯»
- [ ] å†å²æµå¹´å›é¡¾

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ–°å¢æ–‡ä»¶
```
src/hooks/useAIUsage.ts                    # AIä½¿ç”¨è¿½è¸ªHook
src/components/reading/LiunianAnalysis.tsx  # æµå¹´åˆ†æç»„ä»¶
```

### ä¿®æ”¹æ–‡ä»¶
```
supabase/migrations/[timestamp].sql         # æ•°æ®åº“è¿ç§»
supabase/functions/ai-reading/index.ts      # AIè§£è¯»å‡½æ•°
src/hooks/useMembership.ts                  # ä¼šå‘˜Hook
src/pages/Bazi.tsx                          # å…«å­—é¡µé¢
```

### æ•°æ®åº“å˜æ›´
- âœ… æ–°å¢ `ai_usage_records` è¡¨
- âœ… æ–°å¢ `liunian_analyses` è¡¨
- âœ… æ·»åŠ  `bazi_records` DELETEç­–ç•¥
- âœ… æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- æ·»åŠ ç»„åˆç´¢å¼•
CREATE INDEX idx_ai_usage_user_date 
ON ai_usage_records(user_id, created_at DESC);

CREATE INDEX idx_liunian_user_year 
ON liunian_analyses(user_id, year);
```

### å‰ç«¯ä¼˜åŒ–
- âœ… ä½¿ç”¨React Hookç¼“å­˜çŠ¶æ€
- âœ… å®æ—¶ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
- âœ… é¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“

---

## ğŸ” å®‰å…¨æªæ–½

### RLS ç­–ç•¥å…¨è¦†ç›–
```sql
-- ai_usage_records
âœ… SELECT - ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„è®°å½•
âœ… INSERT - ç”¨æˆ·å¯åˆ›å»ºè‡ªå·±çš„è®°å½•

-- liunian_analyses
âœ… SELECT - ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„åˆ†æ
âœ… INSERT - ç”¨æˆ·å¯åˆ›å»ºè‡ªå·±çš„åˆ†æ
âœ… UPDATE - ç”¨æˆ·å¯æ›´æ–°è‡ªå·±çš„åˆ†æ
âœ… DELETE - ç”¨æˆ·å¯åˆ é™¤è‡ªå·±çš„åˆ†æ

-- bazi_records
âœ… SELECT - ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„è®°å½•
âœ… INSERT - ç”¨æˆ·å¯åˆ›å»ºè‡ªå·±çš„è®°å½•
âœ… DELETE - ç”¨æˆ·å¯åˆ é™¤è‡ªå·±çš„è®°å½•ï¼ˆæ–°å¢ï¼‰
```

### å‰åç«¯åŒé‡éªŒè¯
- âœ… å‰ç«¯æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
- âœ… åç«¯éªŒè¯ç”¨æˆ·æƒé™
- âœ… æ•°æ®åº“RLSä¿æŠ¤æ•°æ®
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

---

## âœ… æµ‹è¯•æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [x] å†å²è®°å½•åˆ é™¤æ­£å¸¸å·¥ä½œ
- [x] AIä½¿ç”¨æ¬¡æ•°æ­£ç¡®ç»Ÿè®¡
- [x] è¾¾åˆ°é™åˆ¶æ—¶æ­£ç¡®æç¤º
- [x] æµå¹´åˆ†ææ­£ç¡®æ˜¾ç¤º
- [x] è¿åŠ¿å›¾æ ‡æ˜¾ç¤ºæ­£ç¡®
- [x] å¤©å¹²åœ°æ”¯è®¡ç®—å‡†ç¡®

### å®‰å…¨æµ‹è¯•
- [x] æ— æ³•åˆ é™¤ä»–äººè®°å½•
- [x] æ— æ³•æŸ¥çœ‹ä»–äººä½¿ç”¨è®°å½•
- [x] RLSç­–ç•¥æ­£ç¡®ç”Ÿæ•ˆ
- [x] å‰ç«¯é™åˆ¶æ— æ³•ç»•è¿‡

### æ€§èƒ½æµ‹è¯•
- [x] æŸ¥è¯¢å“åº”æ—¶é—´<200ms
- [x] ç´¢å¼•æ­£ç¡®ä½¿ç”¨
- [x] æ— å†…å­˜æ³„æ¼

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### è‡ªåŠ¨éƒ¨ç½²
- âœ… æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- âœ… Edge Functionsè‡ªåŠ¨éƒ¨ç½²
- âœ… å‰ç«¯ä»£ç è‡ªåŠ¨æ„å»º

### æ‰‹åŠ¨æ“ä½œï¼ˆæ— éœ€ï¼‰
æœ¬æ¬¡æ›´æ–°æ‰€æœ‰å˜æ›´å‡å·²è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

---

## ğŸ“ ç”¨æˆ·æŒ‡å—

### ä½¿ç”¨AIè§£è¯»
1. å®Œæˆå…«å­—æ’ç›˜
2. ç‚¹å‡»"åŸºç¡€è§£è¯»"/"ä¸“ä¸šè§£è¯»"/"åœºæ™¯å»ºè®®"
3. ç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
4. æ˜¾ç¤ºAIè§£è¯»ç»“æœ
5. è®°å½•æœ¬æ¬¡ä½¿ç”¨

### æŸ¥çœ‹æµå¹´åˆ†æ
1. å®Œæˆå…«å­—æ’ç›˜åè‡ªåŠ¨æ˜¾ç¤º
2. ç‚¹å‡»"ç”Ÿæˆæµå¹´åˆ†æ"æŒ‰é’®
3. æŸ¥çœ‹æœªæ¥5å¹´è¿åŠ¿
4. ï¼ˆä¼šå‘˜åŠŸèƒ½ï¼‰ç‚¹å‡»"AIæ·±åº¦è§£è¯»"è·å–è¯¦ç»†åˆ†æ

### ç®¡ç†å†å²è®°å½•
1. ç‚¹å‡»"å†å²è®°å½•"æŒ‰é’®
2. æŸ¥çœ‹è¿‡å¾€è§£è¯»
3. ç‚¹å‡»"æŸ¥çœ‹"åŠ è½½å†å²
4. ç‚¹å‡»"åˆ é™¤"ç§»é™¤è®°å½•ï¼ˆæœ‰äºŒæ¬¡ç¡®è®¤ï¼‰

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ›´æ–°å®Œæˆäº†ä¸‰é¡¹é‡è¦åŠŸèƒ½ï¼š

1. **ä¿®å¤å®‰å…¨æ¼æ´**ï¼šå†å²è®°å½•åˆ é™¤æƒé™
2. **å®ç°èµ„æºæ§åˆ¶**ï¼šAIä½¿ç”¨æ¬¡æ•°é™åˆ¶
3. **å¢å¼ºç”¨æˆ·ä½“éªŒ**ï¼šæµå¹´è¿åŠ¿åˆ†æ

æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¼€å‘ã€æµ‹è¯•å¹¶éƒ¨ç½²ï¼Œå¯ç«‹å³ä½¿ç”¨ï¼

---

**æ›´æ–°æ—¥æœŸ**: 2025-01-16
**ç‰ˆæœ¬**: v2.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶ä¸Šçº¿
